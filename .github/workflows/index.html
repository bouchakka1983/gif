<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magical GIF Maker - Magical GIF Maker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: light-dark(#8a2be2, #a960ff);
            --primary-light: light-dark(#b088e2, #c8a1ff);
            --primary-dark: light-dark(#5a1a9e, #7b3acb);
            --text-color: light-dark(#333, #f0f0f0);
            --background-color: light-dark(#f8f9fc, #121212);
            --card-color: light-dark(#ffffff, #1e1e1e);
            --accent-color: light-dark(#ff7bac, #ff9ccd);
            --input-background: light-dark(#f5f5fd, #333);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --animation-time: 0.5s;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--background-color) 0%, #1a1a2e 100%);
            background-attachment: fixed;
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header Navigation */
        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(138, 43, 226, 0.3);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #ff7bac, #8a2be2, #4b0082);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-links a {
            color: var(--text-color);
            text-decoration: none;
            transition: color 0.3s ease;
            font-weight: 500;
        }

        .nav-links a:hover {
            color: var(--primary-color);
        }

        /* Hero Section */
        .hero {
            padding: 8rem 2rem 4rem;
            text-align: center;
            background: radial-gradient(circle at center, rgba(138, 43, 226, 0.1) 0%, transparent 50%);
        }

        .hero h1 {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, #ff7bac, #8a2be2, #4b0082);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { filter: drop-shadow(0 0 10px rgba(138, 43, 226, 0.5)); }
            to { filter: drop-shadow(0 0 20px rgba(138, 43, 226, 0.8)); }
        }

        .hero p {
            font-size: 1.3rem;
            color: #ccc;
            margin-bottom: 3rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Main App Container */
        .app-container {
            max-width: 900px;
            margin: 2rem auto;
            background: var(--card-color);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 60px var(--shadow-color);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(138, 43, 226, 0.2);
            margin-bottom: 4rem;
        }

        .input-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .input-field {
            display: flex;
            align-items: center;
            background: var(--input-background);
            border-radius: 15px;
            padding: 0 1rem;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .input-field:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.3);
        }

        .input-icon {
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-left: 10px;
        }

        #prompt-input {
            flex: 1;
            border: none;
            outline: none;
            padding: 1rem;
            font-size: 1rem;
            background: transparent;
            color: var(--text-color);
            text-align: right;
        }

        #prompt-input::placeholder {
            color: #888;
        }

        .generate-button {
            background: linear-gradient(45deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 15px;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(138, 43, 226, 0.4);
            position: relative;
            overflow: hidden;
        }

        .generate-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .generate-button:hover::before {
            left: 100%;
        }

        .generate-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(138, 43, 226, 0.6);
        }

        .generate-button.loading {
            background: #666;
            cursor: not-allowed;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        /* Generation Container */
        .generation-container {
            background: var(--input-background);
            border-radius: 20px;
            padding: 2rem;
            min-height: 400px;
            position: relative;
            border: 1px solid rgba(138, 43, 226, 0.1);
        }

        .tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 2px solid rgba(138, 43, 226, 0.2);
            gap: 1rem;
        }

        .tab-button {
            padding: 1rem 2rem;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 1rem;
            font-weight: 600;
            color: #888;
            position: relative;
            transition: all 0.3s ease;
            border-radius: 10px 10px 0 0;
        }

        .tab-button::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary-color);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .tab-button.active {
            color: var(--primary-color);
            background: rgba(138, 43, 226, 0.1);
        }

        .tab-button.active::after {
            transform: scaleX(1);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Frames Container */
        .frames-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1.5rem;
            justify-items: center;
            margin-bottom: 2rem;
        }

        .frame {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 150px;
            height: 150px;
            background: white;
            opacity: 0;
            transform: scale(0.8) rotateY(180deg);
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 3px solid transparent;
        }

        .frame.appear {
            opacity: 1;
            transform: scale(1) rotateY(0deg);
            border-color: var(--primary-color);
        }

        .frame:hover {
            transform: scale(1.05) rotateY(0deg);
            box-shadow: 0 15px 40px rgba(138, 43, 226, 0.4);
        }

        .frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        .frame-number {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(45deg, var(--primary-color), var(--primary-dark));
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 15px;
            z-index: 2;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        /* Result Container */
        .result-container {
            display: none;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            opacity: 0;
            transform: scale(0.9);
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
        }

        .result-container.appear {
            display: flex;
            opacity: 1;
            transform: scale(1);
        }

        .result-container img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 3px solid var(--primary-color);
        }

        .download-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(45deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(138, 43, 226, 0.4);
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

        .download-button:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 15px 40px rgba(138, 43, 226, 0.6);
        }

        /* Status Display */
        .status-container {
            margin-top: 2rem;
            text-align: center;
        }

        .status-display {
            font-size: 1.1rem;
            color: var(--primary-color);
            font-weight: 500;
            padding: 1rem;
            background: rgba(138, 43, 226, 0.1);
            border-radius: 10px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(138, 43, 226, 0.2);
        }

        /* Footer */
        .footer {
            background: var(--card-color);
            padding: 3rem 2rem;
            text-align: center;
            border-top: 1px solid rgba(138, 43, 226, 0.2);
            margin-top: 4rem;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .footer h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .footer p {
            color: #888;
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        .social-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .social-links a {
            color: var(--primary-color);
            font-size: 2rem;
            transition: all 0.3s ease;
        }

        .social-links a:hover {
            transform: translateY(-5px) scale(1.2);
            color: var(--accent-color);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2.5rem;
            }
            
            .nav-links {
                display: none;
            }
            
            .app-container {
                margin: 1rem;
                padding: 1.5rem;
            }
            
            .frames-container {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 1rem;
            }
            
            .frame {
                width: 120px;
                height: 120px;
            }
        }

        /* Loading Animation */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Floating Elements */
        .floating-elements {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .floating-star {
            position: absolute;
            color: var(--primary-color);
            font-size: 1rem;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        /* Demo Section */
        .demo-section {
            max-width: 1200px;
            margin: 4rem auto;
            padding: 2rem;
            text-align: center;
        }

        .demo-section h2 {
            font-size: 2.5rem;
            margin-bottom: 2rem;
            color: var(--primary-color);
        }

        .demo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 3rem;
        }

        .demo-card {
            background: var(--card-color);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px var(--shadow-color);
            border: 1px solid rgba(138, 43, 226, 0.2);
            transition: all 0.3s ease;
        }

        .demo-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 60px rgba(138, 43, 226, 0.2);
        }

        .demo-card h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .demo-card p {
            color: #888;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <!-- Floating Background Elements -->
    <div class="floating-elements">
        <i class="fas fa-star floating-star" style="top: 10%; left: 10%; animation-delay: 0s;"></i>
        <i class="fas fa-sparkles floating-star" style="top: 20%; right: 15%; animation-delay: 1s;"></i>
        <i class="fas fa-magic floating-star" style="top: 70%; left: 20%; animation-delay: 2s;"></i>
        <i class="fas fa-wand-magic-sparkles floating-star" style="top: 60%; right: 10%; animation-delay: 3s;"></i>
    </div>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-wand-magic-sparkles"></i>
                Magical GIF Maker
            </div>
            <ul class="nav-links">
                <li><a href="#home">الرئيسية</a></li>
                <li><a href="#app">التطبيق</a></li>
                <li><a href="#demo">أمثلة</a></li>
                <li><a href="#contact">تواصل</a></li>
            </ul>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero" id="home">
        <h1>Magical GIF Maker</h1>
        <p>Turn your ideas into fun animated doodles</p>
    </section>

    <!-- Main App -->
    <section id="app">
        <div class="app-container">
            <div class="input-container">
                <div class="input-field">
                    <i class="fas fa-wand-magic-sparkles input-icon"></i>
                    <input
                        type="text"
                        id="prompt-input"
                        value="a shiba inu eating ice-cream"
                        placeholder="Type a description of the animation you want..."
                    />
                </div>
                <button id="generate-button" class="generate-button">
                    <span>Generate Magic</span>
                    <i class="fas fa-sparkles"></i>
                </button>
            </div>

            <div class="generation-container">
                <div class="tabs">
                    <button class="tab-button active" data-tab="frames">Frames</button>
                    <button class="tab-button" data-tab="output">Output</button>
                </div>

                <div class="tab-content active" id="frames-content">
                    <div class="frames-container" id="frames-container">
                        <!-- Frames will appear here -->
                    </div>
                </div>

                <div class="tab-content" id="output-content">
                    <div class="result-container" id="result-container">
                        <!-- Final GIF will appear here -->
                    </div>
                </div>
            </div>

            <div class="status-container">
                <div class="status-display" id="status-display">جاهز لإنشاء صورة متحركة رائعة!</div>
            </div>
        </div>
    </section>

    <!-- Demo Section -->
    <section class="demo-section" id="demo">
        <h2>أمثلة على ما يمكنك إنشاؤه</h2>
        <div class="demo-grid">
            <div class="demo-card">
                <h3><i class="fas fa-dog"></i> حيوانات ظريفة</h3>
                <p>قطة ترقص، كلب يجري، أرنب يقفز - اجعل الحيوانات تتحرك بطريقة مذهلة!</p>
            </div>
            <div class="demo-card">
                <h3><i class="fas fa-smile"></i> شخصيات كرتونية</h3>
                <p>أنشئ شخصيات كرتونية تتحرك وتعبر عن المشاعر بطريقة طريفة ومبهجة</p>
            </div>
            <div class="demo-card">
                <h3><i class="fas fa-star"></i> مؤثرات سحرية</h3>
                <p>نجوم تتلألأ، ألوان تتراقص، أشكال هندسية تتحول - كل شيء ممكن!</p>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer" id="contact">
        <div class="footer-content">
            <h3>صانع الصور المتحركة السحري</h3>
            <p>أطلق العنان لإبداعك مع الذكاء الاصطناعي</p>
            <div class="social-links">
                <a href="#"><i class="fab fa-twitter"></i></a>
                <a href="#"><i class="fab fa-instagram"></i></a>
                <a href="#"><i class="fab fa-facebook"></i></a>
                <a href="#"><i class="fab fa-youtube"></i></a>
            </div>
            <p>&copy; 2024 Magical GIF Maker. جميع الحقوق محفوظة.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script type="importmap">
    {
        "imports": {
            "@google/genai": "https://esm.sh/@google/genai@^0.7.0",
            "gifenc": "https://cdn.jsdelivr.net/npm/gifenc@^1.0.3/+esm"
        }
    }
    </script>

    <script type="module">
        import { GoogleGenAI, Modality } from '@google/genai';
        import { applyPalette, GIFEncoder, quantize } from 'gifenc';

        // Note: في الإنتاج الفعلي، يجب الحصول على مفتاح API من Google AI Studio
        // وتخزينه بشكل آمن في متغيرات البيئة
        const API_KEY = 'AIzaSyCQjOg0Z-mf5ZEjss5jpQf3Kbmkh5aUCOA'; // يجب استبدال هذا بمفتاحك الحقيقي
        
        let ai;
        try {
            ai = new GoogleGenAI({ apiKey: API_KEY });
        } catch (error) {
            console.error('خطأ في تهيئة Google AI:', error);
        }

        const fps = 4;

        // DOM elements
        const promptInput = document.getElementById('prompt-input');
        const generateButton = document.getElementById('generate-button');
        const framesContainer = document.getElementById('frames-container');
        const resultContainer = document.getElementById('result-container');
        const statusDisplay = document.getElementById('status-display');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        function parseError(error) {
            const regex = /{"error":(.*)}/gm;
            const m = regex.exec(error);
            try {
                const e = m[1];
                const err = JSON.parse(e);
                return err.message;
            } catch (e) {
                return error;
            }
        }

        async function createGifFromPngs(imageUrls, targetWidth = 1024, targetHeight = 1024) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                throw new Error('فشل في إنشاء سياق اللوحة');
            }
            const gif = GIFEncoder();
            const fpsInterval = 1 / fps;
            const delay = fpsInterval * 1000;

            for (const url of imageUrls) {
                const img = new Image();
                img.src = url;
                await new Promise((resolve) => {
                    img.onload = resolve;
                });
                canvas.width = targetWidth;
                canvas.height = targetHeight;
                ctx.fillStyle = '#ffffff';
                ctx.clearRect(0, 0, targetWidth, targetHeight);
                ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
                const data = ctx.getImageData(0, 0, targetWidth, targetHeight).data;
                const format = 'rgb444';
                const palette = quantize(data, 256, { format });
                const index = applyPalette(data, palette, format);
                gif.writeFrame(index, targetWidth, targetHeight, { palette, delay });
            }

            gif.finish();
            const buffer = gif.bytesView();
            const blob = new Blob([buffer], { type: 'image/gif' });
            const url = URL.createObjectURL(blob);
            const img = new Image();
            img.src = url;
            return img;
        }

        function updateStatus(message) {
            if (statusDisplay) {
                statusDisplay.innerHTML = `<i class="fas fa-magic"></i> ${message}`;
            }
        }

        function switchTab(targetTab) {
            tabButtons.forEach((button) => {
                if (button.getAttribute('data-tab') === targetTab) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            tabContents.forEach((content) => {
                if (content.id === `${targetTab}-content`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            if (targetTab === 'output' && resultContainer) {
                resultContainer.style.display = 'flex';
            }
        }

        async function run(value) {
            if (!ai) {
                updateStatus('خطأ: لم يتم تهيئة Google AI بشكل صحيح. يرجى التحقق من مفتاح API.');
                return false;
            }

            if (framesContainer) framesContainer.textContent = '';
            if (resultContainer) resultContainer.textContent = '';
            resultContainer?.classList.remove('appear');
            switchTab('frames');
            if (resultContainer) resultContainer.style.display = 'none';

            updateStatus('جاري إنشاء الإطارات...');
            if (generateButton) {
                generateButton.disabled = true;
                generateButton.classList.add('loading');
                generateButton.innerHTML = '<div class="loading-spinner"></div> جاري الإنشاء...';
            }

            try {
                const prompt = `رسم متحرك بسيط على خلفية بيضاء يُظهر ${value}. حركة بسيطة ولكن لا يتحرك شيء آخر.`;
                const style = `رسم بسيط، ملون بألوان زاهية، نمط رسم يدوي`;

                const response = await ai.models.generateContentStream({
                    model: 'gemini-2.0-flash-preview-image-generation',
                    contents: `أنشئ على الأقل 5 إطارات مربعة بخلفية بيضاء لرسوم متحركة بسيطة بألوان زاهية تُظهر ${prompt}.

**المتطلبات الإجبارية:**

**النمط:** ${style}.
**الخلفية:** بيضاء سادة (بدون ألوان أو عناصر خلفية). لا توجد خلفية سوداء على الإطلاق.
**المحتوى والحركة:** وضح بوضوح العمل **${prompt}** مع موضوع ملون ومتحرك (لا صور ثابتة). إذا كان هناك عمل محدد، فيجب أن يكون الاختلاف الرئيسي بين الإطارات.
**عدد الإطارات:** على الأقل 5 إطارات تُظهر التطور المستمر وعلى الأكثر 10 إطارات.
**التنسيق:** صورة مربعة (نسبة العرض إلى الارتفاع 1:1).
**القص:** لا توجد أشرطة سوداء أو صندوق عريض على الإطلاق؛ الرسم الملون مرئي بالكامل على خلفية بيضاء.
**الإخراج:** ملفات صور فعلية لصورة متحركة سلسة بنمط رسم ملون على خلفية بيضاء. تأكد من أن كل إطار مختلف بما فيه الكفاية عن السابق.`,
                    config: {
                        temperature: 1,
                        responseModalities: [Modality.IMAGE, Modality.TEXT],
                    },
                });

                const images = [];
                let frameCount = 0;

                for await (const chunk of response) {
                    if (chunk.candidates && chunk.candidates[0].content?.parts) {
                        for (const part of chunk.candidates[0].content.parts) {
                            if (part.inlineData && framesContainer) {
                                frameCount++;
                                updateStatus(`تم إنشاء الإطار ${frameCount}`);

                                // Create a frame element
                                const frameElement = document.createElement('div');
                                frameElement.className = 'frame';

                                // Create and add the frame number
                                const frameNumber = document.createElement('div');
                                frameNumber.className = 'frame-number';
                                frameNumber.textContent = frameCount.toString();
                                frameElement.appendChild(frameNumber);

                                // Create the image
                                const src = `data:image/png;base64,${part.inlineData.data}`;
                                const img = document.createElement('img');
                                img.width = 1024;
                                img.height = 1024;
                                img.src = src;

                                // Add it to our frame element
                                frameElement.appendChild(img);
                                framesContainer.appendChild(frameElement);

                                // Store URL for GIF creation
                                images.push(src);

                                // Animate the frame appearance
                                setTimeout(() => {
                                    frameElement.classList.add('appear');
                                }, frameCount * 200);
                            }
                        }
                    }
                }

                if (frameCount < 2) {
                    updateStatus('فشل في إنشاء أي إطارات. جرب مطالبة أخرى.');
                    return false;
                }

                // Update status
                updateStatus('جاري إنشاء الصورة المتحركة...');

                // Create the GIF
                const img = await createGifFromPngs(images);
                img.className = 'result-image';

                // Clear and add to result container
                if (resultContainer) {
                    resultContainer.appendChild(img);

                    // Add download button
                    const downloadButton = document.createElement('button');
                    downloadButton.className = 'download-button';
                    const icon = document.createElement('i');
                    icon.className = 'fas fa-download';
                    downloadButton.appendChild(icon);
                    downloadButton.onclick = () => {
                        const a = document.createElement('a');
                        a.href = img.src;
                        a.download = 'magical-animation.gif';
                        a.click();
                    };
                    resultContainer.appendChild(downloadButton);

                    switchTab('output');
                    setTimeout(() => {
                        resultContainer.classList.add('appear');
                        document.getElementById('app').scrollIntoView({ behavior: 'smooth' });
                    }, 300);
                }

                updateStatus('تم الانتهاء! صورتك المتحركة السحرية جاهزة ✨');
            } catch (error) {
                const msg = parseError(error.toString());
                console.error('Error generating animation:', error);
                updateStatus(`خطأ في إنشاء الصورة المتحركة: ${msg}`);
                return false;
            } finally {
                if (generateButton) {
                    generateButton.disabled = false;
                    generateButton.classList.remove('loading');
                    generateButton.innerHTML = '<span>إنشاء السحر</span><i class="fas fa-sparkles"></i>';
                }
            }
            return true;
        }

        // Initialize the app
        function main() {
            // Show demo message if no API key
            if (!API_KEY || API_KEY === 'YOUR_GOOGLE_AI_API_KEY') {
                updateStatus('⚠️ يرجى إضافة مفتاح Google AI API الخاص بك لاستخدام التطبيق');
            }

            if (generateButton) {
                generateButton.addEventListener('click', async () => {
                    if (promptInput) {
                        const value = promptInput.value.trim();
                        if (value) {
                            const retries = 3;
                            for (let i = 0; i < retries; i++) {
                                if (await run(value)) {
                                    console.log('تم الانتهاء.');
                                    return;
                                } else {
                                    console.log(`إعادة المحاولة...`);
                                }
                            }
                            console.log('توقف المحاولة :(');
                        }
                    }
                });
            }

            if (promptInput) {
                promptInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        generateButton?.click();
                    }
                });
                promptInput.addEventListener('focus', (e) => {
                    promptInput.select();
                    e.preventDefault();
                });
            }

            tabButtons.forEach((button) => {
                button.addEventListener('click', () => {
                    const targetTab = button.getAttribute('data-tab');
                    if (targetTab) switchTab(targetTab);
                });
            });

            // Smooth scrolling for navigation links
            document.querySelectorAll('.nav-links a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('href').substring(1);
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth' });
                    }
                });
            });

            switchTab('frames');
        }

        main();
    </script>
</body>
</html>